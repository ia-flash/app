---
version: '3.4'
services:
  nginx:
    image: ${PROJECT_NAME}-nginx-${EXEC_ENV}:${APP_VERSION}
    container_name: ${PROJECT_NAME}-nginx-${EXEC_ENV}
    build:
      context: ${NGINX_PATH}
      target: ${EXEC_ENV}
      dockerfile: Dockerfile
    expose:
      - 80
    labels:
      - traefik.enable=true
      - traefik.http.routers.nginx.entrypoints=http
      - traefik.http.routers.nginx.rule=Host(`localhost`)
      - traefik.http.services.nginx.loadbalancer.server.port=80
    volumes:
      - ./nginx/dist:/usr/share/nginx/html
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - isolated_nw
  traefik:
    image: ${PROJECT_NAME}-traefik-${EXEC_ENV}:${APP_VERSION}
    container_name: ${PROJECT_NAME}-traefik-${EXEC_ENV}
    build:
      context: ${TRAEFIK_PATH}
      target: ${EXEC_ENV}
      dockerfile: Dockerfile
    security_opt:
      - no-new-privileges:true
    command:
      - "--log.level=${LOG_LEVEL}"
      - "--entryPoints.http.address=:80"
      - "--entryPoints.https.address=:443"
      - "--providers.docker=true" 
      - "--providers.docker.watch=true"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.exposedByDefault=false"
    ports:
      - ${APP_PORT}:80
      - 443:443
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/acme.json:/acme.json
    networks:
      - isolated_nw

networks:
  isolated_nw:
    external:
      name: isolated_nw
